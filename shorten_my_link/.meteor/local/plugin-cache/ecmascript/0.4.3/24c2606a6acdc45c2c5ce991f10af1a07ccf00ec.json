{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/mongo/observe_changes_tests.js","filenameRelative":"/packages/mongo/observe_changes_tests.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/mongo/observe_changes_tests.js.map","sourceFileName":"/packages/mongo/observe_changes_tests.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"observe_changes_tests"},"ignored":false,"code":"var makeCollection = function makeCollection() {\n  if (Meteor.isServer) return new Mongo.Collection(Random.id());else return new Mongo.Collection(null);\n};\n\n_.each([{ added: 'added', forceOrdered: true }, { added: 'added', forceOrdered: false }, { added: 'addedBefore', forceOrdered: false }], function (options) {\n  var added = options.added;\n  var forceOrdered = options.forceOrdered;\n  Tinytest.addAsync(\"observeChanges - single id - basics \" + added + (forceOrdered ? \" force ordered\" : \"\"), function (test, onComplete) {\n    var c = makeCollection();\n    var counter = 0;\n    var callbacks = [added, \"changed\", \"removed\"];\n    if (forceOrdered) callbacks.push(\"movedBefore\");\n    withCallbackLogger(test, callbacks, Meteor.isServer, function (logger) {\n      var barid = c.insert({ thing: \"stuff\" });\n      var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n\n      var handle = c.find(fooid).observeChanges(logger);\n      if (added === 'added') logger.expectResult(added, [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }]);else logger.expectResult(added, [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }, null]);\n      c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\" });\n      logger.expectResult(\"changed\", [fooid, { noodles: \"alright\", potatoes: \"tasty\", bacon: undefined }]);\n\n      c.remove(fooid);\n      logger.expectResult(\"removed\", [fooid]);\n\n      c.remove(barid);\n\n      c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n      logger.expectNoResult();\n      handle.stop();\n\n      var badCursor = c.find({}, { fields: { noodles: 1, _id: false } });\n      test.throws(function () {\n        badCursor.observeChanges(logger);\n      });\n\n      onComplete();\n    });\n  });\n});\n\nTinytest.addAsync(\"observeChanges - callback isolation\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handles = [];\n    var cursor = c.find();\n    handles.push(cursor.observeChanges(logger));\n    // fields-tampering observer\n    handles.push(cursor.observeChanges({\n      added: function () {\n        function added(id, fields) {\n          fields.apples = 'green';\n        }\n\n        return added;\n      }(),\n      changed: function () {\n        function changed(id, fields) {\n          fields.apples = 'green';\n        }\n\n        return changed;\n      }()\n    }));\n\n    var fooid = c.insert({ apples: \"ok\" });\n    logger.expectResult(\"added\", [fooid, { apples: \"ok\" }]);\n\n    c.update(fooid, { apples: \"not ok\" });\n    logger.expectResult(\"changed\", [fooid, { apples: \"not ok\" }]);\n\n    test.equal(c.findOne(fooid).apples, \"not ok\");\n\n    _.each(handles, function (handle) {\n      handle.stop();\n    });\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - single id - initial adds\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n    var handle = c.find(fooid).observeChanges(logger);\n    logger.expectResult(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - unordered - initial adds\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n    var barid = c.insert({ noodles: \"good\", bacon: \"weird\", apples: \"ok\" });\n    var handle = c.find().observeChanges(logger);\n    logger.expectResultUnordered([{ callback: \"added\",\n      args: [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }] }, { callback: \"added\",\n      args: [barid, { noodles: \"good\", bacon: \"weird\", apples: \"ok\" }] }]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - unordered - basics\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handle = c.find().observeChanges(logger);\n    var barid = c.insert({ thing: \"stuff\" });\n    logger.expectResultOnly(\"added\", [barid, { thing: \"stuff\" }]);\n\n    var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n\n    logger.expectResultOnly(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }]);\n\n    c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\" });\n    c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\" });\n    logger.expectResultOnly(\"changed\", [fooid, { noodles: \"alright\", potatoes: \"tasty\", bacon: undefined }]);\n    c.remove(fooid);\n    logger.expectResultOnly(\"removed\", [fooid]);\n    c.remove(barid);\n    logger.expectResultOnly(\"removed\", [barid]);\n\n    fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n\n    logger.expectResult(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nif (Meteor.isServer) {\n  Tinytest.addAsync(\"observeChanges - unordered - specific fields\", function (test, onComplete) {\n    var c = makeCollection();\n    withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n      var handle = c.find({}, { fields: { noodles: 1, bacon: 1 } }).observeChanges(logger);\n      var barid = c.insert({ thing: \"stuff\" });\n      logger.expectResultOnly(\"added\", [barid, {}]);\n\n      var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n\n      logger.expectResultOnly(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\" }]);\n\n      c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\" });\n      logger.expectResultOnly(\"changed\", [fooid, { noodles: \"alright\", bacon: undefined }]);\n      c.update(fooid, { noodles: \"alright\", potatoes: \"meh\", apples: \"ok\" });\n      c.remove(fooid);\n      logger.expectResultOnly(\"removed\", [fooid]);\n      c.remove(barid);\n      logger.expectResultOnly(\"removed\", [barid]);\n\n      fooid = c.insert({ noodles: \"good\", bacon: \"bad\" });\n\n      logger.expectResult(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\" }]);\n      logger.expectNoResult();\n      handle.stop();\n      onComplete();\n    });\n  });\n\n  Tinytest.addAsync(\"observeChanges - unordered - specific fields + selector on excluded fields\", function (test, onComplete) {\n    var c = makeCollection();\n    withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n      var handle = c.find({ mac: 1, cheese: 2 }, { fields: { noodles: 1, bacon: 1, eggs: 1 } }).observeChanges(logger);\n      var barid = c.insert({ thing: \"stuff\", mac: 1, cheese: 2 });\n      logger.expectResultOnly(\"added\", [barid, {}]);\n\n      var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\", mac: 1, cheese: 2 });\n\n      logger.expectResultOnly(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\" }]);\n\n      c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\", mac: 1, cheese: 2 });\n      logger.expectResultOnly(\"changed\", [fooid, { noodles: \"alright\", bacon: undefined }]);\n\n      // Doesn't get update event, since modifies only hidden fields\n      c.update(fooid, { noodles: \"alright\", potatoes: \"meh\", apples: \"ok\", mac: 1, cheese: 2 });\n      logger.expectNoResult();\n\n      c.remove(fooid);\n      logger.expectResultOnly(\"removed\", [fooid]);\n      c.remove(barid);\n      logger.expectResultOnly(\"removed\", [barid]);\n\n      fooid = c.insert({ noodles: \"good\", bacon: \"bad\", mac: 1, cheese: 2 });\n\n      logger.expectResult(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\" }]);\n      logger.expectNoResult();\n      handle.stop();\n      onComplete();\n    });\n  });\n}\n\nTinytest.addAsync(\"observeChanges - unordered - specific fields + modify on excluded fields\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handle = c.find({ mac: 1, cheese: 2 }, { fields: { noodles: 1, bacon: 1, eggs: 1 } }).observeChanges(logger);\n    var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\", mac: 1, cheese: 2 });\n\n    logger.expectResultOnly(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\" }]);\n\n    // Noodles go into shadow, mac appears as eggs\n    c.update(fooid, { $rename: { noodles: 'shadow', apples: 'eggs' } });\n    logger.expectResultOnly(\"changed\", [fooid, { eggs: \"ok\", noodles: undefined }]);\n\n    c.remove(fooid);\n    logger.expectResultOnly(\"removed\", [fooid]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - unordered - unset parent of observed field\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, ['added', 'changed', 'removed'], Meteor.isServer, function (logger) {\n    var handle = c.find({}, { fields: { 'type.name': 1 } }).observeChanges(logger);\n    var id = c.insert({ type: { name: 'foobar' } });\n    logger.expectResultOnly('added', [id, { type: { name: 'foobar' } }]);\n\n    c.update(id, { $unset: { type: 1 } });\n    test.equal(c.find().fetch(), [{ _id: id }]);\n    logger.expectResultOnly('changed', [id, { type: undefined }]);\n\n    handle.stop();\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - unordered - enters and exits result set through change\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handle = c.find({ noodles: \"good\" }).observeChanges(logger);\n    var barid = c.insert({ thing: \"stuff\" });\n\n    var fooid = c.insert({ noodles: \"good\", bacon: \"bad\", apples: \"ok\" });\n    logger.expectResultOnly(\"added\", [fooid, { noodles: \"good\", bacon: \"bad\", apples: \"ok\" }]);\n\n    c.update(fooid, { noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\" });\n    logger.expectResultOnly(\"removed\", [fooid]);\n    c.remove(fooid);\n    c.remove(barid);\n\n    fooid = c.insert({ noodles: \"ok\", bacon: \"bad\", apples: \"ok\" });\n    c.update(fooid, { noodles: \"good\", potatoes: \"tasty\", apples: \"ok\" });\n    logger.expectResult(\"added\", [fooid, { noodles: \"good\", potatoes: \"tasty\", apples: \"ok\" }]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nif (Meteor.isServer) {\n  testAsyncMulti(\"observeChanges - tailable\", [function (test, expect) {\n    var self = this;\n    var collName = \"cap_\" + Random.id();\n    var coll = new Mongo.Collection(collName);\n    coll._createCappedCollection(1000000);\n    self.xs = [];\n    self.expects = [];\n    self.insert = function (fields) {\n      coll.insert(_.extend({ ts: new MongoInternals.MongoTimestamp(0, 0) }, fields));\n    };\n\n    // Tailable observe shouldn't show things that are in the initial\n    // contents.\n    self.insert({ x: 1 });\n    // Wait for one added call before going to the next test function.\n    self.expects.push(expect());\n\n    var cursor = coll.find({ y: { $ne: 7 } }, { tailable: true });\n    self.handle = cursor.observeChanges({\n      added: function () {\n        function added(id, fields) {\n          self.xs.push(fields.x);\n          test.notEqual(self.expects.length, 0);\n          self.expects.pop()();\n        }\n\n        return added;\n      }(),\n      changed: function () {\n        function changed() {\n          test.fail({ unexpected: \"changed\" });\n        }\n\n        return changed;\n      }(),\n      removed: function () {\n        function removed() {\n          test.fail({ unexpected: \"removed\" });\n        }\n\n        return removed;\n      }()\n    });\n\n    // Nothing happens synchronously.\n    test.equal(self.xs, []);\n  }, function (test, expect) {\n    var self = this;\n    // The cursors sees the first element.\n    test.equal(self.xs, [1]);\n    self.xs = [];\n\n    self.insert({ x: 2, y: 3 });\n    self.insert({ x: 3, y: 7 }); // filtered out by the query\n    self.insert({ x: 4 });\n    // Expect two added calls to happen.\n    self.expects = [expect(), expect()];\n  }, function (test, expect) {\n    var self = this;\n    test.equal(self.xs, [2, 4]);\n    self.xs = [];\n    self.handle.stop();\n\n    self.insert({ x: 5 });\n    // XXX This timeout isn't perfect but it's pretty hard to prove that an\n    // event WON'T happen without something like a write fence.\n    Meteor.setTimeout(expect(), 1000);\n  }, function (test, expect) {\n    var self = this;\n    test.equal(self.xs, []);\n  }]);\n}\n\ntestAsyncMulti(\"observeChanges - bad query\", [function (test, expect) {\n  var c = makeCollection();\n  var observeThrows = function observeThrows() {\n    test.throws(function () {\n      c.find({ __id: { $in: null } }).observeChanges({\n        added: function () {\n          function added() {\n            test.fail(\"added shouldn't be called\");\n          }\n\n          return added;\n        }()\n      });\n    }, '$in needs an array');\n  };\n\n  if (Meteor.isClient) {\n    observeThrows();\n    return;\n  }\n\n  // Test that if two copies of the same bad observeChanges run in parallel\n  // and are de-duped, both observeChanges calls will throw.\n  var Fiber = Npm.require('fibers');\n  var Future = Npm.require('fibers/future');\n  var f1 = new Future();\n  var f2 = new Future();\n  Fiber(function () {\n    // The observeChanges call in here will yield when we talk to mongod,\n    // which will allow the second Fiber to start and observe a duplicate\n    // query.\n    observeThrows();\n    f1['return']();\n  }).run();\n  Fiber(function () {\n    test.isFalse(f1.isResolved()); // first observe hasn't thrown yet\n    observeThrows();\n    f2['return']();\n  }).run();\n  f1.wait();\n  f2.wait();\n}]);","ast":null,"map":{"version":3,"sources":["/packages/mongo/observe_changes_tests.js"],"names":[],"mappings":"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","file":"/packages/mongo/observe_changes_tests.js.map","sourcesContent":["var makeCollection = function () {\n  if (Meteor.isServer)\n    return new Mongo.Collection(Random.id());\n  else\n    return new Mongo.Collection(null);\n};\n\n_.each ([{added:'added', forceOrdered: true},\n         {added:'added', forceOrdered: false},\n         {added: 'addedBefore', forceOrdered: false}], function (options) {\n           var added = options.added;\n           var forceOrdered = options.forceOrdered;\n  Tinytest.addAsync(\"observeChanges - single id - basics \"\n                    + added\n                    + (forceOrdered ? \" force ordered\" : \"\"),\n                    function (test, onComplete) {\n    var c = makeCollection();\n    var counter = 0;\n    var callbacks = [added, \"changed\", \"removed\"];\n    if (forceOrdered)\n      callbacks.push(\"movedBefore\");\n    withCallbackLogger(test,\n                       callbacks,\n                       Meteor.isServer,\n                       function (logger) {\n    var barid = c.insert({thing: \"stuff\"});\n    var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n\n    var handle = c.find(fooid).observeChanges(logger);\n    if (added === 'added')\n      logger.expectResult(added, [fooid, {noodles: \"good\", bacon: \"bad\",apples: \"ok\"}]);\n    else\n      logger.expectResult(added,\n                          [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}, null]);\n    c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\"});\n    logger.expectResult(\"changed\",\n                        [fooid, {noodles: \"alright\", potatoes: \"tasty\", bacon: undefined}]);\n\n    c.remove(fooid);\n    logger.expectResult(\"removed\", [fooid]);\n\n    c.remove(barid);\n\n    c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n    logger.expectNoResult();\n    handle.stop();\n\n    var badCursor = c.find({}, {fields: {noodles: 1, _id: false}});\n    test.throws(function () {\n      badCursor.observeChanges(logger);\n    });\n\n    onComplete();\n    });\n  });\n});\n\nTinytest.addAsync(\"observeChanges - callback isolation\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handles = [];\n    var cursor = c.find();\n    handles.push(cursor.observeChanges(logger));\n    // fields-tampering observer\n    handles.push(cursor.observeChanges({\n      added: function(id, fields) {\n        fields.apples = 'green';\n      },\n      changed: function(id, fields) {\n        fields.apples = 'green';\n      },\n    }));\n\n    var fooid = c.insert({apples: \"ok\"});\n    logger.expectResult(\"added\", [fooid, {apples: \"ok\"}]);\n\n    c.update(fooid, {apples: \"not ok\"})\n    logger.expectResult(\"changed\", [fooid, {apples: \"not ok\"}]);\n\n    test.equal(c.findOne(fooid).apples, \"not ok\");\n\n    _.each(handles, function(handle) { handle.stop(); });\n    onComplete();\n  });\n\n});\n\nTinytest.addAsync(\"observeChanges - single id - initial adds\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n  var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n  var handle = c.find(fooid).observeChanges(logger);\n  logger.expectResult(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}]);\n  logger.expectNoResult();\n  handle.stop();\n  onComplete();\n  });\n});\n\n\n\nTinytest.addAsync(\"observeChanges - unordered - initial adds\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n  var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n  var barid = c.insert({noodles: \"good\", bacon: \"weird\", apples: \"ok\"});\n  var handle = c.find().observeChanges(logger);\n  logger.expectResultUnordered([\n    {callback: \"added\",\n     args: [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}]},\n    {callback: \"added\",\n     args: [barid, {noodles: \"good\", bacon: \"weird\", apples: \"ok\"}]}\n  ]);\n  logger.expectNoResult();\n  handle.stop();\n  onComplete();\n  });\n});\n\nTinytest.addAsync(\"observeChanges - unordered - basics\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n  var handle = c.find().observeChanges(logger);\n  var barid = c.insert({thing: \"stuff\"});\n  logger.expectResultOnly(\"added\", [barid, {thing: \"stuff\"}]);\n\n  var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n\n  logger.expectResultOnly(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}]);\n\n  c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\"});\n  c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\"});\n  logger.expectResultOnly(\"changed\",\n                      [fooid, {noodles: \"alright\", potatoes: \"tasty\", bacon: undefined}]);\n  c.remove(fooid);\n  logger.expectResultOnly(\"removed\", [fooid]);\n  c.remove(barid);\n  logger.expectResultOnly(\"removed\", [barid]);\n\n  fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n\n  logger.expectResult(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}]);\n  logger.expectNoResult();\n  handle.stop();\n  onComplete();\n  });\n});\n\nif (Meteor.isServer) {\n  Tinytest.addAsync(\"observeChanges - unordered - specific fields\", function (test, onComplete) {\n    var c = makeCollection();\n    withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n      var handle = c.find({}, {fields:{noodles: 1, bacon: 1}}).observeChanges(logger);\n      var barid = c.insert({thing: \"stuff\"});\n      logger.expectResultOnly(\"added\", [barid, {}]);\n\n      var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n\n      logger.expectResultOnly(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\"}]);\n\n      c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\"});\n      logger.expectResultOnly(\"changed\",\n                              [fooid, {noodles: \"alright\", bacon: undefined}]);\n      c.update(fooid, {noodles: \"alright\", potatoes: \"meh\", apples: \"ok\"});\n      c.remove(fooid);\n      logger.expectResultOnly(\"removed\", [fooid]);\n      c.remove(barid);\n      logger.expectResultOnly(\"removed\", [barid]);\n\n      fooid = c.insert({noodles: \"good\", bacon: \"bad\"});\n\n      logger.expectResult(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\"}]);\n      logger.expectNoResult();\n      handle.stop();\n      onComplete();\n    });\n  });\n\n  Tinytest.addAsync(\"observeChanges - unordered - specific fields + selector on excluded fields\", function (test, onComplete) {\n    var c = makeCollection();\n    withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n      var handle = c.find({ mac: 1, cheese: 2 },\n                          {fields:{noodles: 1, bacon: 1, eggs: 1}}).observeChanges(logger);\n      var barid = c.insert({thing: \"stuff\", mac: 1, cheese: 2});\n      logger.expectResultOnly(\"added\", [barid, {}]);\n\n      var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\", mac: 1, cheese: 2});\n\n      logger.expectResultOnly(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\"}]);\n\n      c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\", mac: 1, cheese: 2});\n      logger.expectResultOnly(\"changed\",\n                              [fooid, {noodles: \"alright\", bacon: undefined}]);\n\n      // Doesn't get update event, since modifies only hidden fields\n      c.update(fooid, {noodles: \"alright\", potatoes: \"meh\", apples: \"ok\", mac: 1, cheese: 2});\n      logger.expectNoResult();\n\n      c.remove(fooid);\n      logger.expectResultOnly(\"removed\", [fooid]);\n      c.remove(barid);\n      logger.expectResultOnly(\"removed\", [barid]);\n\n      fooid = c.insert({noodles: \"good\", bacon: \"bad\", mac: 1, cheese: 2});\n\n      logger.expectResult(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\"}]);\n      logger.expectNoResult();\n      handle.stop();\n      onComplete();\n    });\n  });\n}\n\nTinytest.addAsync(\"observeChanges - unordered - specific fields + modify on excluded fields\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n    var handle = c.find({ mac: 1, cheese: 2 },\n                        {fields:{noodles: 1, bacon: 1, eggs: 1}}).observeChanges(logger);\n    var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\", mac: 1, cheese: 2});\n\n    logger.expectResultOnly(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\"}]);\n\n\n    // Noodles go into shadow, mac appears as eggs\n    c.update(fooid, {$rename: { noodles: 'shadow', apples: 'eggs' }});\n    logger.expectResultOnly(\"changed\",\n                            [fooid, {eggs:\"ok\", noodles: undefined}]);\n\n    c.remove(fooid);\n    logger.expectResultOnly(\"removed\", [fooid]);\n    logger.expectNoResult();\n    handle.stop();\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\n  \"observeChanges - unordered - unset parent of observed field\",\n  function (test, onComplete) {\n    var c = makeCollection();\n    withCallbackLogger(\n      test, ['added', 'changed', 'removed'], Meteor.isServer,\n      function (logger) {\n        var handle = c.find({}, {fields: {'type.name': 1}}).observeChanges(logger);\n        var id = c.insert({ type: { name: 'foobar' } });\n        logger.expectResultOnly('added', [id, { type: { name: 'foobar' } }]);\n\n        c.update(id, { $unset: { type: 1 } });\n        test.equal(c.find().fetch(), [{ _id: id }]);\n        logger.expectResultOnly('changed', [id, { type: undefined }]);\n\n        handle.stop();\n        onComplete();\n      }\n    );\n  }\n);\n\n\n\nTinytest.addAsync(\"observeChanges - unordered - enters and exits result set through change\", function (test, onComplete) {\n  var c = makeCollection();\n  withCallbackLogger(test, [\"added\", \"changed\", \"removed\"], Meteor.isServer, function (logger) {\n  var handle = c.find({noodles: \"good\"}).observeChanges(logger);\n  var barid = c.insert({thing: \"stuff\"});\n\n  var fooid = c.insert({noodles: \"good\", bacon: \"bad\", apples: \"ok\"});\n  logger.expectResultOnly(\"added\", [fooid, {noodles: \"good\", bacon: \"bad\", apples: \"ok\"}]);\n\n  c.update(fooid, {noodles: \"alright\", potatoes: \"tasty\", apples: \"ok\"});\n  logger.expectResultOnly(\"removed\",\n                      [fooid]);\n  c.remove(fooid);\n  c.remove(barid);\n\n  fooid = c.insert({noodles: \"ok\", bacon: \"bad\", apples: \"ok\"});\n  c.update(fooid, {noodles: \"good\", potatoes: \"tasty\", apples: \"ok\"});\n  logger.expectResult(\"added\", [fooid, {noodles: \"good\", potatoes: \"tasty\", apples: \"ok\"}]);\n  logger.expectNoResult();\n  handle.stop();\n  onComplete();\n  });\n});\n\n\nif (Meteor.isServer) {\n  testAsyncMulti(\"observeChanges - tailable\", [\n    function (test, expect) {\n      var self = this;\n      var collName = \"cap_\" + Random.id();\n      var coll = new Mongo.Collection(collName);\n      coll._createCappedCollection(1000000);\n      self.xs = [];\n      self.expects = [];\n      self.insert = function (fields) {\n        coll.insert(_.extend({ts: new MongoInternals.MongoTimestamp(0, 0)},\n                             fields));\n      };\n\n      // Tailable observe shouldn't show things that are in the initial\n      // contents.\n      self.insert({x: 1});\n      // Wait for one added call before going to the next test function.\n      self.expects.push(expect());\n\n      var cursor = coll.find({y: {$ne: 7}}, {tailable: true});\n      self.handle = cursor.observeChanges({\n        added: function (id, fields) {\n          self.xs.push(fields.x);\n          test.notEqual(self.expects.length, 0);\n          self.expects.pop()();\n        },\n        changed: function () {\n          test.fail({unexpected: \"changed\"});\n        },\n        removed: function () {\n          test.fail({unexpected: \"removed\"});\n        }\n      });\n\n      // Nothing happens synchronously.\n      test.equal(self.xs, []);\n    },\n    function (test, expect) {\n      var self = this;\n      // The cursors sees the first element.\n      test.equal(self.xs, [1]);\n      self.xs = [];\n\n      self.insert({x: 2, y: 3});\n      self.insert({x: 3, y: 7});  // filtered out by the query\n      self.insert({x: 4});\n      // Expect two added calls to happen.\n      self.expects = [expect(), expect()];\n    },\n    function (test, expect) {\n      var self = this;\n      test.equal(self.xs, [2, 4]);\n      self.xs = [];\n      self.handle.stop();\n\n      self.insert({x: 5});\n      // XXX This timeout isn't perfect but it's pretty hard to prove that an\n      // event WON'T happen without something like a write fence.\n      Meteor.setTimeout(expect(), 1000);\n    },\n    function (test, expect) {\n      var self = this;\n      test.equal(self.xs, []);\n    }\n  ]);\n}\n\n\ntestAsyncMulti(\"observeChanges - bad query\", [\n  function (test, expect) {\n    var c = makeCollection();\n    var observeThrows = function () {\n      test.throws(function () {\n        c.find({__id: {$in: null}}).observeChanges({\n          added: function () {\n            test.fail(\"added shouldn't be called\");\n          }\n        });\n      }, '$in needs an array');\n    };\n\n    if (Meteor.isClient) {\n      observeThrows();\n      return;\n    }\n\n    // Test that if two copies of the same bad observeChanges run in parallel\n    // and are de-duped, both observeChanges calls will throw.\n    var Fiber = Npm.require('fibers');\n    var Future = Npm.require('fibers/future');\n    var f1 = new Future;\n    var f2 = new Future;\n    Fiber(function () {\n      // The observeChanges call in here will yield when we talk to mongod,\n      // which will allow the second Fiber to start and observe a duplicate\n      // query.\n      observeThrows();\n      f1['return']();\n    }).run();\n    Fiber(function () {\n      test.isFalse(f1.isResolved());  // first observe hasn't thrown yet\n      observeThrows();\n      f2['return']();\n    }).run();\n    f1.wait();\n    f2.wait();\n  }\n]);\n"]},"hash":"24c2606a6acdc45c2c5ce991f10af1a07ccf00ec"}
